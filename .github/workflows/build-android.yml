name: Build Android APK

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:  
      - name: Checkout repo  
        uses: actions/checkout@v4  

      - name: Setup Node  
        uses: actions/setup-node@v4  
        with:  
          node-version: 20  

      - name: Install npm deps  
        run: npm install  

      - name: Optimize React for performance
        run: bash scripts/react-optimize.sh

      - name: Build React (ignore eslint warnings)  
        run: CI=false npm run build  

      - name: Install Capacitor  
        run: npm install @capacitor/android @capacitor/cli  

      - name: Init Capacitor (if needed)  
        run: |  
          if [ ! -f capacitor.config.json ]; then  
            npx cap init DZIDICI3 com.dzidici.app  
          fi  
          npx cap add android || true  

      - name: Copy web assets  
        run: npx cap copy android  

      - name: Setup Java 21  
        uses: actions/setup-java@v4  
        with:  
          distribution: temurin  
          java-version: 21  
          cache: gradle  

      # ðŸ”¥ OVO JE KLJUÄŒNI FIX ZA KOTLIN DUPLIKATE  
      - name: Force single Kotlin version  
        run: |  
          cat <<'EOF' >> android/build.gradle  

          subprojects {  
            configurations.all {  
              resolutionStrategy {  
                force "org.jetbrains.kotlin:kotlin-stdlib:1.8.22"  
                force "org.jetbrains.kotlin:kotlin-stdlib-jdk7:1.8.22"  
                force "org.jetbrains.kotlin:kotlin-stdlib-jdk8:1.8.22"  
              }  
            }  
          }  
          EOF  

      - name: Build Debug APK  
        working-directory: android  
        run: ./gradlew assembleDebug  

      - name: Upload APK  
        uses: actions/upload-artifact@v4  
        with:  
          name: DZIDICI3-debug-apk  
          path: android/app/build/outputs/apk/debug/app-debug.apk
